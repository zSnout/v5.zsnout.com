This is the source code for the third iteration of https://zsnout.com/. Mostly, this document is for personal reference, so there might be some details missing. For more information, check out JSDoc comments, which are available on all exported members. Additionally, expected environment variables are included in the NodeJS.ProcessEnv interface.

- [](#)
- [REPL](#repl)
- [Markdown Directives](#markdown-directives)
- [Schema Systems](#schema-systems)
  - [Schema Definition](#schema-definition)
  - [Using Schemas](#using-schemas)

## Building the Project

To build files, run the `build` script. Once `build` has been run at least once, you may run `watch` to automatically rebuild files when they change.

Our list of build scripts includes TypeScript, Sass, EJS, and Markdown. We also recompile JavaScript files in `client` with UglifyJS to improve the end-user experience.

## REPL

If you want to debug some stuff, you can run 'npm run repl'. This runs Node's normal REPL, but starts the zSnout server automatically and places the Fastify instance into the `server` variable.

## Markdown Directives

The following code is an example of using directives, and was generated by `server/md.ts`.

```md
# heading

\directive1

\directive2 Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.

Euismod quis viverra nibh cras pulvinar mattis.

\directive 3
Tincidunt ornare massa eget egestas purus viverra accumsan.
Nunc sed augue lacus viverra vitae congue eu.

# heading 2

Tellus in metus vulputate eu scelerisque.

\directive Justo eget magna fermentum iaculis.

# heading 3

Diam phasellus vestibulum lorem sed risus ultricies.

---
```

```html
<h1 id="heading" tabindex="-1">heading</h1>
<div class="directive1">
  <p class="directive2">
    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
    tempor incididunt ut labore et dolore magna aliqua.
  </p>
  <p>Euismod quis viverra nibh cras pulvinar mattis.</p>
  <p class="directive">
    3 Tincidunt ornare massa eget egestas purus viverra accumsan. Nunc sed augue
    lacus viverra vitae congue eu.
  </p>
</div>
<h1 id="heading-2" tabindex="-1">heading 2</h1>
<p>Tellus in metus vulputate eu scelerisque.</p>
<p class="directive">Justo eget magna fermentum iaculis.</p>
<h1 id="heading-3" tabindex="-1">heading 3</h1>
<p>Diam phasellus vestibulum lorem sed risus ultricies.</p>
<hr />
```

## Schema Systems

Because we think that schema systems like JSON Schema and JTD are too wordy, we came up with our own super-simple format. There is a demonstration below. More documentation is available in the [Schema Definition](#schema-definition) section.

```ts
// Sample Array
[
  {
    name: "Zachary Sakowitz",
    username: "zsakowitz",
    email: "zsakowitz@zsnout.com",
    workHours: 2, // this is nullable
    isAdmin: true, // this is optional
  },
  {
    name: "NoReply",
    username: "noreply",
    email: "noreply@zsnout.com",
    workHours: null,
  },
];

// JSON Schema
({
  type: "array",
  items: {
    type: "object",
    properties: {
      name: { type: "string" },
      username: { type: "string" },
      email: { type: "string" },
      workHours: { type: "number" },
      isAdmin: { type: "boolean" },
    },
    required: ["name", "username", "email"],
  },
});

// JTD (JSON Type Definitions)
({
  type: "array",
  items: {
    properties: {
      name: { type: "string" },
      username: { type: "string" },
      email: { type: "string" },
      workHours: { type: "number" },
    },
    optionalProperties: {
      isAdmin: { type: "boolean" },
    },
  },
});

// zSnout's Schema System
[
  {
    name: "string",
    username: "string",
    email: "string", // "string" is the type of the item
    workHours: "number?", // the ? here says that the value is nullable
    "isAdmin?": "boolean", // the ? here says that the property is optional
  },
];
```

As you can see from the example above, our system is much smaller than other options available currently.s

### Schema Definition

We have four core types: `number`, `string`, `boolean`, and `null`. You can check for these by using a string. For example,

```ts
// schema
"boolean";

// possible matches
true;

// invalid matches
57;
```

matches `true`, but doesn't match `23` or `null`.

Additionally, there is an `any` type that matches numbers, strings, booleans, arrays, and objects. It does NOT MATCH null or undefined.

Because having nullable types is so useful, we added shortcuts for nullable variations of `number`, `string`, `boolean`, and `any`. For example, `number?` matches `null` and `number`.

```ts
// schema
"string?";

// possible matches
"myname";
null;

// invalid matches
undefined;
```

We also have types for arrays, tuples, and objects. An array is an array of schemas. This allows the array to contain any of these types.

```ts
// schema
["string", "number"];

// possible matches
["zsnout", 23];
[39, "lorem ipsum", `239`8];
[];

// invalid matches
[true];
["zsnout", null];
```

Tuple types are like arrays, but they start with the `tuple` keyword.

```ts
// schema
["tuple", "string", "number"];

// possible matches
["zsnout", 23];
["lorem ipsum", `239`8];

// invalid matches
[true, "lorem ipsum", null];
[];
```

Object types specify a set of properties. Each key is the name of a property, and each value is the schema for that property. To make a property optional, add `?` to the end of the key.

```ts
// schema
({
  "username?": "string",
  fullName: "string",
  "emails?": ["string"],
  age: "number?",
});

// possible matches
({
  fullName: "Frederick Gerrison",
  username: "fredgerrison",
  age: `278`,
});
({
  fullName: "Anita Geller",
  emails: ["anita_geller@example.com"],
  age: `318`,
});

// invalid matches
({
  fullName: "Jaron Lisk",
  username: "jaronlisk",
});
({
  fullName: "Quan Pou",
  emails: ["quanpou@example.com", "quanpou@work.example.com"],
  age: null,
});
```

### Using Schemas

On the client-side, the `validate` function exported from [client/assets/js/validate.ts](client/assets/js/validate.ts) can check if data matches a certain schema. Additionally, the `fetch` function exported from [client/assets/js/fetch.ts](client/assets/js/fetch.ts) has a schema option that should be specified when dealing with data sent from the server.

On the server-side you can specify a `schema` option in `server.capture`. There are five subschema you can specify: `body`, `headers`, `params`, `query`, and `reply`. The first four are checked by Fastify at runtime. `reply` is only checked by TypeScript. Additionally, you may send an object with the signature `{ error: true; message: string }` from `reply.send`.
